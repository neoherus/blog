<!doctype html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><link rel="shortcut icon" type="image/x-icon" href="" media="screen"><title>用Canvas实现图层 - vimcaw的个人博客</title><link rel="stylesheet" href="/blog/css/post-6f8e6878ec074fe1d711486113b2d862.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><link rel="shortcut icon" href="/blog/image/favicon-d75f01b3d24560fb09e136bdc6e2d396.ico" type="image/vnd.microsoft.icon"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?46649aaca124d5d1bfd6d10d28ddb51d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><header id="top"><div class="top-inner"><div class="icon"><a href="/blog/"><img src="/blog/image/icon-0fd3804fbdfc60e0756c074adef5769e.png" alt="">vimcaw的个人博客</a></div><div class="site-nav"><a href="/blog/">首页</a><ul class="site-category-list"><li class="site-category-list-item"><a class="site-category-list-link" href="/blog/categories/C/">C#</a></li><li class="site-category-list-item"><a class="site-category-list-link" href="/blog/categories/Hexo/">Hexo</a></li><li class="site-category-list-item"><a class="site-category-list-link" href="/blog/categories/Web前端/">Web前端</a></li><li class="site-category-list-item"><a class="site-category-list-link" href="/blog/categories/个人项目/">个人项目</a></li><li class="site-category-list-item"><a class="site-category-list-link" href="/blog/categories/软件/">软件</a></li></ul></div></div></header><div class="content"><div class="sidebar"><div class="loader">Loading...</div></div><div class="main"><header>用Canvas实现图层</header><div class="info"><div class="category"><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/blog/categories/Web前端/">Web前端</a></li></ul></div><ul><li><span class="iconfont icon-publish">发表于 </span><span class="date" title="2018-02-10 16:32:56">2018-02-10</span></li><li><span class="iconfont icon-update">最后更新于 </span><span class="date" title="2018-02-10 16:33:00">2018-02-10</span></li><li class="tag"><span class="iconfont icon-tags">标签:</span><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/canvas/">canvas</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/图层/">图层</a></li></ul></li></ul></div><article><p>在做一些绘图类应用时，有时会遇到处理“图层”的问题，而HTML5原生的Canvas并没有“图层”的概念，所以需要一些特别的手段来实现多图层绘图。本文介绍一种多<code>canvas</code>重叠模拟图层的方法来实现多图层的各种操作。<br><a id="more"></a></p><h1 id="绘图区构建"><a href="#绘图区构建" class="headerlink" title="绘图区构建"></a>绘图区构建</h1><p>用一个父元素作为容器，把所有的<code>canvas</code>元素设置成一样的宽高并放在里面重叠。<br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"500"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"500"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p></p><p>具体方法是父元素设置为<code>相对定位</code>，所有<code>canvas</code>设置为<code>绝对定位</code>，并且设置<code>left</code>和<code>top</code>为<code>0</code>，使所有的<code>canvas</code>元素重叠<br></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.container</span>&#123;<br>    <span class="hljs-attribute">position</span>: relative;<br>&#125;<br><span class="hljs-selector-class">.container</span> <span class="hljs-selector-tag">canvas</span>&#123;<br>    <span class="hljs-attribute">position</span>: absolute;<br>    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;<br>    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p></p><h1 id="图层操作"><a href="#图层操作" class="headerlink" title="图层操作"></a>图层操作</h1><p>一般还会有<code>图层管理面板</code>来进行图层的操作，需要保持<code>canvas</code>元素状态和<code>图层管理面板</code>同步，用原生js来操作<code>DOM</code>实现是极其繁琐的，推荐使用一种框架，比如<code>Vue</code>、<code>React</code>、<code>Angular</code>等来进行。由于不同框架实现图层操作方法不同，这里只给出原生js的实现思路。</p><h2 id="新建图层"><a href="#新建图层" class="headerlink" title="新建图层"></a>新建图层</h2><p>操作<code>DOM</code>，在父容器上新增<code>canvas</code>元素，并将其宽高设置为绘图区宽高。</p><h2 id="删除图层"><a href="#删除图层" class="headerlink" title="删除图层"></a>删除图层</h2><p>操作<code>DOM</code>，在父容器上删除图层对应的<code>canvas</code>元素。</p><h2 id="切换当前图层"><a href="#切换当前图层" class="headerlink" title="切换当前图层"></a>切换当前图层</h2><p>获取对应图层的<code>context</code>，赋值给当前<code>context</code>。</p><h2 id="改变图层顺序"><a href="#改变图层顺序" class="headerlink" title="改变图层顺序"></a>改变图层顺序</h2><p>操作<code>DOM</code>，把<code>canvas</code>元素的顺序随之改变。</p><h2 id="变换图层"><a href="#变换图层" class="headerlink" title="变换图层"></a>变换图层</h2><p>为了方便，使用原生<code>canvas API</code>里面的各种API即可：</p><ul><li>移动：<code>translate(x, y)</code></li><li>旋转：<code>rotate(angle)</code></li><li>缩放：<code>scale(x, y)</code></li><li>变形：<code>transform(m11, m12, m21, m22, dx, dy)</code></li></ul><p>详见：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial/Transformations" target="_blank" rel="noopener">变形 Transformations - Web API 接口 | MDN</a></p><h1 id="绘图区的保存与导出"><a href="#绘图区的保存与导出" class="headerlink" title="绘图区的保存与导出"></a>绘图区的保存与导出</h1><h2 id="导出图像"><a href="#导出图像" class="headerlink" title="导出图像"></a>导出图像</h2><p>分别导出所有<code>canvas</code>元素的图像，并按照图层从底部到顶部的顺序，绘制到一个<code>canvas</code>元素中，再导出图像。<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> canvases = <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">'canvas'</span>),<br>    canvasOutput = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'canvas'</span>),<br>    ctxOutput = canvasOutput.getContext(<span class="hljs-string">'2d'</span>);<br><br><span class="hljs-comment">//倒序遍历canvas元素，并将其按顺序绘制在同一个canvas元素上，合成为一个图层</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = canvases.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>    <span class="hljs-keyword">let</span> image = <span class="hljs-keyword">new</span> Image();<br>    image.src = canvases[i].toDataURL();<br>    ctxOutput.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">//导出合成图像的src（Base64编码），可通过toDataURL函数的参数指定导出格式</span><br><span class="hljs-keyword">let</span> srcOutput = canvasOutput.toDataURL();<br></code></pre></td></tr></table></figure><p></p><h2 id="保存绘图区状态"><a href="#保存绘图区状态" class="headerlink" title="保存绘图区状态"></a>保存绘图区状态</h2><p>记录各图层图像、名称、顺序等信息，其中图像使用<code>Base64</code>编码成字符串，其它信息直接使用字符串，共同保存为一个<code>json</code>文件，进行压缩，读取时，只需解压后还原各图层即可。</p><p>这里简单列出保存文件的大致实现方法，没有进行压缩。<br></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> doc = &#123;<br>    <span class="hljs-attr">layers</span>: []<br>&#125;;<br><br><span class="hljs-comment">//遍历canvas元素，保存其图像</span><br>canvases.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">canvas</span>) </span>&#123;<br>    doc.layers.push(&#123;<br>        <span class="hljs-attr">image</span>: canvas.toDataURL()<br>    &#125;);<br>&#125;);<br><br>download.href = <span class="hljs-string">"data:application/octet-stream;base64,"</span> + btoa(<span class="hljs-built_in">JSON</span>.stringify(doc));<br></code></pre></td></tr></table></figure><p></p></article><div class="end"><span>The End</span></div><div class="copyright-announce"><p>© 本文著作权归 <a href="https://github.com/vimcaw">vimcaw</a> 所有，未经许可，不得转载使用。</p></div><div id="lv-container" data-id="city" data-uid="MTAyMC8zNDA4MS8xMDYxOQ=="><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div></div><div id="nav" class="iconfont icon-menu circle-button"></div><div class="shade"></div><a href="#top" data-scroll id="back-to-top" class="iconfont icon-top circle-button"></a><div id="image-view" class="hidden"><img src="" alt=""></div></div><footer><ul class="social"><li><a href="https://github.com/vimcaw" title="GitHub账号：https://github.com/vimcaw" class="iconfont icon-githublogo"></a></li><li><a href="mailto:vimcaw@gmail.com" title="Email: vimcaw@gmail.com" class="iconfont icon-icon-email"></a></li><li><a href="https://www.zhihu.com/people/zhu-chang-sheng-87/" title="知乎账号: https://www.zhihu.com/people/zhu-chang-sheng-87/" class="iconfont icon-zhihu0"></a></li></ul><div class="copyright"><p>Copyright © <span id="current-year">current</span> <a href="https://github.com/vimcaw"><span>vimcaw</span></a></p></div><div class="powered-by"><p>Powered by <a href="https://hexo.io/">Hexo</a></p></div></footer><script src="https://unpkg.com/tippy.js@2.2.3/dist/tippy.all.min.js"></script><script>document.getElementById("current-year").innerText=(new Date).getFullYear(),tippy(".date",{arrow:!0,size:"small"})</script><script src="/blog/js/tocbot.min-271e01ad72f187fb4d86767f81287ae3.js"></script><script src="/blog/js/post-5a6377fc62817670462dc161cd883267.js"></script></body></html>